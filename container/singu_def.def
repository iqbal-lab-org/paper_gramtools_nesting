# Usage: `sudo singularity build built/image_name.img singu_def.def`
# Tested on: singularity v3.4.0-1

BootStrap: docker
From: ubuntu:latest  

%post
    export DEBIAN_FRONTEND=noninteractive

	# essentials
	apt-get update
	apt-get install -y \
	build-essential \
	automake \
	cmake \
	git \
	pkg-config \
	python3 \
	python3-pip \
	wget \
	zlib1g-dev

	pip3 install pip==20.0.2 # upgrade pip


	# analysis tools

	## art_ilmn (read simulation)
	cd ${HOME}
	ln -s /usr/lib/x86_64-linux-gnu/libgsl.so /usr/lib/x86_64-linux-gnu/libgsl.so.0
	wget https://www.niehs.nih.gov/research/resources/assets/docs/artsrcmountrainier2016.06.05linux.tgz
	tar xvf artsrcmountrainier2016.06.05linux.tgz
	cp art_src_MountRainier_Linux/art_illumina /usr/bin/
	rm -r artsrcmountrainier2016.06.05linux.tgz art_src_MountRainier_Linux


	## samtools & bcftools
	cd ${HOME}
	apt-get install -y libncurses5-dev libbz2-dev liblzma-dev tabix
	wget https://github.com/samtools/samtools/releases/download/1.10/samtools-1.10.tar.bz2
	tar -xf samtools-1.10.tar.bz2 && cd samtools-1.10 && ./configure && make && make install && cd .. && rm -r samtools-1.10

	cd ${HOME}
	wget https://github.com/samtools/bcftools/releases/download/1.10.2/bcftools-1.10.2.tar.bz2
	tar -xf bcftools-1.10.2.tar.bz2 && cd bcftools-1.10.2 && ./configure && make && make install && cd .. && rm -r bcftools-1.10.2
	

	## bedtools
	cd ${HOME}
	wget https://github.com/arq5x/bedtools2/releases/download/v2.29.2/bedtools.static.binary
	chmod a+x bedtools.static.binary && mv bedtools.static.binary /usr/bin/bedtools

	## mafft (multiple seq alignments)
	cd ${HOME}
	wget https://mafft.cbrc.jp/alignment/software/mafft_7.450-1_amd64.deb -O mafft && dpkg -i mafft && rm mafft

	## RAxML (phylo trees)
	cd ${HOME}
	git clone https://github.com/stamatak/standard-RAxML && cd standard-RAxML && make -j 2 -f Makefile.PTHREADS.gcc
	cp raxmlHPC-PTHREADS /usr/bin/

	## bowtie2 (read to genome alignment)
	cd ${HOME}
	wget https://github.com/BenLangmead/bowtie2/releases/download/v2.4.1/bowtie2-2.4.1-linux-x86_64.zip
	unzip bowtie2-2.4.1-linux-x86_64.zip
	cp bowtie2-2.4.1-linux-x86_64/bowtie* /usr/bin/ && rm -r bowtie2-2.4.1-linux-x86_64*

	## make_prg
	cd ${HOME}
	git clone https://github.com/rmcolq/make_prg.git
	cd make_prg && git checkout bcd7f7dba42aa29d5fe6a75f9e1c9abd129ae62b
	python3 setup.py install


	/*************/
	/* gramtools */
	/*************/
	#apt-get install -y g++-8
    #ln -sf /usr/bin/g++-8 /usr/bin/g++ # Default to g++-8

	# gramtools::cortex
	apt-get install -y python python-dev r-base

	cd ${HOME}
	git clone https://github.com/iqbal-lab-org/gramtools
	cd gramtools && git checkout 465102ee23d7b7cfbdda4d4c50a86ea8a8e50332
	mkdir cmake-build-release && cd cmake-build-release
	cmake .. -DCMAKE_BUILD_TYPE=REL_WITH_ASSERTS
	make -j 4 encode_prg combine_jvcfs
	cp ../libgramtools/submods/encode_prg.bin /usr/bin/encode_prg
	cp ../libgramtools/submods/combine_jvcfs.bin /usr/bin/combine_jvcfs

	cd ..
	pip3 install .	


%environment
    export LC_ALL=C

%labels
    Author Brice Letcher
